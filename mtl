#!/bin/sh
set -e

mtl_dir="/home/$USER/.medial_temporal_lobe"
usage() {
    echo
    echo "USAGE: $0 mtl [action] [url] [-ht] [--mtl-dir directory]"
    echo
    echo '-h  Help'
    echo '-t  Tags, comma-separated, allowed characters: [a-z_]'
    echo
}

# Check dependencies
if ! which uuidgen > /dev/null; then
    echo 'You need to install uuidgen.'
    exit 1
fi

while [ $# -gt 0 ]
do
    case "$1" in
        --mtl-dir) mtl_dir="$2"
            shift;;
        -t) tags="$2"
            shift;;
        -h) usage
            exit;;
        -*) usage >&2
            exit 1;;
        *)  if test -z "$action"; then
              action="$1"
            elif test -z "$url"; then
              url="$1"
            else
              break
            fi;;
    esac
    shift
done

# Check the required parameters.
if test "$action" != 'add'; then
    echo Only the \"add\" action is supported right now.
    exit 11
elif test -z "$url"; then
    usage
    exit 11
fi

# Standardize url
if ! echo "$url" | grep -E '^https?://'; then
    url="http://$url"
fi

# Check that the memory directory exists.
if ! test -e "$mtl_dir"; then
    echo "You must create $mtl_dir."
    exit 12
fi

# Check whether the page exists
if test $(ls "$mtl_dir/memories/" | wc -l) -gt 0 && grep -E "url=$url" "$mtl_dir/memories/"*"/info"; then
    echo "$url" is already saved.
    exit 13
fi

# Check whether the tags are valid.
if echo "$tags" | grep '[^a-z_,]' > /dev/null; then
    echo 'Tags may only contain lowercase letters and underscores and must be separated by commas.'
    exit 14
fi

# Save the page.
uuid=$(uuidgen)
mkdir -p "$mtl_dir/memories/$uuid"
if ! wget -U "Mozilla/5.0 (Windows NT 5.1; rv:10.0.2) Gecko/20100101 Firefox/10.0.2" -O "$mtl_dir/memories/$uuid/source" "$url"; then
    # Clean up on failure.
    rm -R "$mtl_dir/memories/$uuid"
    exit 15
fi

# Save some information.
echo "url=$url" > "$mtl_dir/memories/$uuid/info"
echo added=$(date --rfc-3339 ns) >> "$mtl_dir/memories/$uuid/info"

# Save tags
for tag in $(echo $tags | tr ',' '\n'); do
    mkdir -p "$mtl_dir/tags/$tag"
    (
        cd "$mtl_dir/tags/$tag"
        ln -s ../../memories/$uuid .
    )
done
